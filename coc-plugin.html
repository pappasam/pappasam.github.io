
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://samroeca.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://samroeca.com/theme/pygments/tango.min.css">
  <link rel="stylesheet" type="text/css" href="https://samroeca.com/theme/font-awesome/css/font-awesome.min.css">

    <link href="https://samroeca.com/static/custom.css" rel="stylesheet">

    <link href="https://samroeca.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Software Journeyman Atom">


    <link rel="shortcut icon" href="/theme/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/theme/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-117115805-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Samuel Roeca" />
<meta name="description" content="In this post, I build a &#34;coc.nvim&#34; extension that wraps an executable language server. By the end of this article, you should both understand what makes coc an amazing LSP client and be able to write your own coc extension." />
<meta name="keywords" content="Vim, Vim Plugins, LSP">

<meta property="og:site_name" content="Software Journeyman"/>
<meta property="og:title" content="How to write a coc.nvim extension"/>
<meta property="og:description" content="In this post, I build a &#34;coc.nvim&#34; extension that wraps an executable language server. By the end of this article, you should both understand what makes coc an amazing LSP client and be able to write your own coc extension."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://samroeca.com/coc-plugin.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-08-14 00:00:00-05:00"/>
<meta property="article:modified_time" content="2020-08-14 00:00:00-05:00"/>
<meta property="article:author" content="https://samroeca.com/author/samuel-roeca.html">
<meta property="article:section" content="Software Development"/>
<meta property="article:tag" content="Vim"/>
<meta property="article:tag" content="Vim Plugins"/>
<meta property="article:tag" content="LSP"/>
<meta property="og:image" content="/images/sam-headshot-kepler-300x300.jpg">

  <title>Software Journeyman &ndash; How to write a coc.nvim extension</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://samroeca.com">
        <img src="/images/sam-headshot-kepler-300x300.jpg" alt="" title="">
      </a>
      <h1><a href="https://samroeca.com"></a></h1>

<p>Sam's blog</p>
      <nav>
        <ul class="list">
          <li><a href="https://samroeca.com/pages/about.html#about">About me</a></li>
          <li><a href="https://samroeca.com/pages/portfolio.html#portfolio">Portfolio</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/pappasam" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin-square" href="https://www.linkedin.com/in/samuel-roeca-23010735" target="_blank"><i class="fa fa-linkedin-square"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/sam.roeca" target="_blank"><i class="fa fa-facebook"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/SamRoeca" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-youtube" href="https://www.youtube.com/channel/UCjORdFKiDlqzzW7bWYqXuKA?view_as=subscriber" target="_blank"><i class="fa fa-youtube"></i></a></li>
        <li><a class="sc-envelope-o" href="mailto:samuel.roeca@gmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://samroeca.com">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://samroeca.com/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="coc-plugin">How to write a coc.nvim extension</h1>
    <p>
      Posted on Fri 14 August 2020 in <a href="https://samroeca.com/category/software-development.html">Software Development</a>

    </p>
  </header>


  <div>
    <p>In this post, I build a "coc.nvim" extension that wraps an executable language server. By the end of this article, you should both understand what makes coc an amazing LSP client and be able to write your own coc extension.</p>


<h2>Requirements</h2>
<p>For the interactive parts of this post, you'll need the following:</p>
<ul>
<li>A POSIX-compliant terminal (bash, zsh, etc), or the ability to translate</li>
<li><a href="https://git-scm.com/">git</a></li>
<li><a href="https://nodejs.org/en/">Node.js&gt;=8.10.0</a></li>
<li><a href="https://github.com/yarnpkg/yarn">yarn&gt;=1.22.4</a></li>
<li><a href="https://github.com/vim/vim">Vim 8+</a> or <a href="https://github.com/neovim/neovim">Neovim 0.4.4+</a></li>
<li><a href="https://github.com/neoclide/coc.nvim">coc.nvim==0.0.78</a> (might work on newer versions, but no promises)</li>
<li>Some knowledge of TypeScript might be helpful</li>
</ul>
<p>Finally, please disable any Python-specific coc extensions that you currently have installed (<a href="https://github.com/pappasam/coc-jedi">coc-jedi</a>, etc).</p>
<h2>Background</h2>
<p><a href="https://github.com/neoclide/coc.nvim">coc.nvim</a>, short for "conquer of completion", is an <a href="https://microsoft.github.io/language-server-protocol/overviews/lsp/overview/">lsp</a> client that targets <a href="https://www.vim.org/">Vim</a>. Vim (in my case, technically <a href="https://neovim.io">NeoVim</a>) is my favorite text editor / IDE. I like its extensibility, flexibility, and in-terminal slickness. Over the years, plenty of tools/plugins have been built for Vim that make it easy to program in multiple languages. Here are some examples:</p>
<ul>
<li>JavaScript intellisense: <a href="https://github.com/ternjs/tern_for_vim">tern_for_vim</a></li>
<li>Ruby on rails intellisense: <a href="https://github.com/tpope/vim-rails">vim-rails</a></li>
<li>General linting: <a href="https://github.com/vim-syntastic/syntastic">syntastic</a></li>
<li>Python intellisense: <a href="https://github.com/davidhalter/jedi-vim">jedi-vim</a></li>
</ul>
<p>Vim's diverse plugins and community-supported tooling are what first drew me to the editor, and they're what still keep me here. Sadly for me, not all software developers use Vim. See its share of developers from the <a href="https://insights.stackoverflow.com/survey/2019#technology-_-most-popular-development-environments">2019 StackOverflow developer survey</a>:</p>
<p><img alt="stack overflow survey" src="./images/coc-plugin/so-2019-dev-env.png"></p>
<p>Popular editors (and platforms) tend to have more software developed for them. For example, many developers have historically targeted Windows <strong>for its users</strong>, not because they <a href="https://www.quora.com/Why-do-computer-programmers-love-Linux-and-hate-Windows">like writing code on Windows</a>. Mo' people, mo' software. To further complicate things, different programming languages tended to be popular with different editors: Vim's Java development environment was historically abysmal enough to generate some <a href="https://news.ycombinator.com/item?id=9713478">heated conversations</a> concluding that only the most obstinate, impractical developers would even consider it for Java development.</p>
<p>This sad historical reality kept language tooling development isolated to editors that were popular within a language: PyCharm/Vim for Python, <a href="https://www.eclipse.org/eclipseide/">Eclipse</a> for Java, etc. This, in turn, would force developers into mind-bending context switches when changing languages. Not only would we need to learn a new language, we'd also need to learn a whole new text editor and tooling ecosystem! Since software tooling is somewhat of a religion, there was no way you could get some developers (eg, me) to even consider touching Java if I had to sacrifice my beliefs (Vim/development tooling I'd grown accustomed to).</p>
<p>In 2015/2016, when things seemed most dire and intractable, the developers behind VSCode had a big idea: why don't we abstract all this divergent, isolated tooling into a <a href="https://en.wikipedia.org/wiki/Communication_protocol">protocol</a> that generalizes the problem of language tooling. Thus, the language server protocol was born.</p>
<h3>Language Server Protocol</h3>
<p>The "Language Server Protocol" (LSP) is a specification that describes communication between a "language client" and a "language server". The following definitions are appropriated from the <a href="https://microsoft.github.io/language-server-protocol/overviews/lsp/overview/">lsp spec overview</a>:</p>
<ul>
<li><strong>Language server:</strong> a program that contains language-specific "smarts" that can communicate with development tooling through the LSP</li>
<li><strong>Language client:</strong> a program, developed in the environment of a "development tool", that can send, receive, and act on LSP messages with a "language server"</li>
<li><strong>Development tool:</strong> Vim, Neovim, VS Code, Eclipse, etc. Basically, a text editor or IDE that software developers use to develop software</li>
</ul>
<p><img alt="Language Server Protocol" src="https://microsoft.github.io/language-server-protocol/overviews/lsp/img/language-server-sequence.png"></p>
<p>Above, the language client is sitting in the development tool and sending <a href="https://en.wikipedia.org/wiki/JSON-RPC">JSON-RPC</a> requests to a language server. All this basically means that your text editor is asking questions to an entity that knows way more about your programming language and responding to its suggested actions. These actions may range from "you should autocomplete some text" to "this symbol's definition can be found by opening this file and navigating to this precise position). In short, the orchestrated communication outlined above realizes the following dream:</p>
<ol>
<li>Language tooling developers write 1 program (the language server) to target every development tool (Vim, VS Code, etc)</li>
<li>Development tool developers write 1 program (the language client) that knows how to communicate with all language servers</li>
<li>Software developers have first-class language support for all languages in their favorite editor; no more text-editor context switching!</li>
</ol>
<p>The above dream seemed like it would herald a new dawn for developers: we can all happily use our favorite tools and have similar language support! Unfortunately, VSCode's popularity has made things a bit more complicated in 2020...</p>
<h3>VSCode: client power</h3>
<p>The LSP dream described in the previous section was similar to <a href="https://en.wikipedia.org/wiki/Tim_Berners-Lee">Tim Berners-Lee</a>'s dream for a world wide web: web clients, supporting web protocols, could enable communication between web servers and a user environment (the operating system). This dream sparked development of all sorts of web clients (browsers) and culminated in the <a href="https://en.wikipedia.org/wiki/Browser_wars">first browser war</a>. According to Wikipedia, during this time, Netscape Navigator and Internet Explorer implemented proprietary html tags like <code>&lt;blink&gt;</code> for Navigator and <code>&lt;marquee&gt;</code> for Internet Explorer. They also rapidly developed their own features and began diverging from <a href="https://en.wikipedia.org/wiki/World_Wide_Web_Consortium">W3C</a>'s recommended spec. This resulted in efficient Internet Explorer HTML being less efficient or broken on Navigator (and vise versa). This forced users to pick browsers based on custom compatibility with their favorite sites and ultimately resulted in <a href="https://en.wikipedia.org/wiki/United_States_v._Microsoft_Corp.">United States v. Microsoft Corp</a>. Basically, things got ugly.</p>
<p><img alt="Browser wars" src="https://joaopsilva.github.io/talks/End-to-End-JavaScript-with-the-MEAN-Stack/img/ie-vs-netscape.jpg"></p>
<p>Although what is happening today in the text editing community is tamer, it resembles the first browser war in that VSCode has become the de-facto standard for Language Clients. Authors of Language Servers may target VSCode without fully supporting the current LSP spec or by inadvertently support VSCode features that are not in the spec. This means that <a href="https://atom.io/">Atom</a> users might be using a correctly-implemented language client that does not work with certain language servers. Additionally, there may be no way to easily configure certain language servers without VSCode's configuration options. This means that if you want to get the best language support possible across all language servers, as of August 2020, you pretty much need to use something that resembles VSCode.</p>
<p>Luckily, <a href="https://github.com/neoclide">Qiming zhao</a> and <a href="https://github.com/fannheyward">Heyward Fann</a> realized that this problem could be solved for Vim by basically implementing a VSCode bridge for Neovim. They named this LSP bridge:</p>
<p><img alt="coc" src="https://user-images.githubusercontent.com/251450/55009068-f4ed2780-501c-11e9-9a3b-cf3aa6ab9272.png"></p>
<h3>coc.nvim</h3>
<p><a href="https://github.com/neoclide/coc.nvim">coc.nvim</a> is a language client for Vim that can be configured similarly to VSCode's language client. Vim is configured with <a href="https://en.wikipedia.org/wiki/Vim_%28text_editor%29#Vim_script">Vim script</a>, <a href="https://en.wikipedia.org/wiki/C_%28programming_language%29">C</a>, <a href="https://en.wikipedia.org/wiki/Lua_%28programming_language%29">lua</a> (if using Neovim), and any other language if you're feeling fancy enough these days. VSCode is configured with <a href="https://en.wikipedia.org/wiki/JSON">json</a> and <a href="https://en.wikipedia.org/wiki/TypeScript">TypeScript</a>. "coc.nvim" makes it so we can configure "coc.nvim"-managed features using <code>json</code> and <code>typescript</code> while still being able to use Vim's configuration for everything else. Basically, it's this:</p>
<p><img alt="have your cake and eat it too" src="https://teflgeek.files.wordpress.com/2012/05/cake-and-eating-it-too.jpeg"></p>
<p>The rest of this article assumes that your development tool is Vim/Neovim, your language client is "coc.nvim" (which we will call coc from now on), and that you are developing in a POSIX-compliant environment (Linux, Mac, Windows 10 Ubuntu, etc).</p>
<h2>Vim / coc terminology</h2>
<ul>
<li>Vim: Vim or Neovim</li>
<li>vimrc: <code>~/.config/nvim/init.vim</code> for Neovim or <code>~/.vimrc</code> for Vim</li>
<li>coc-settings.json: <code>~/.config/nvim/.coc-settings.json</code> by default</li>
</ul>
<h2>Coc as simple LSP wrapper</h2>
<p>Without an extension, coc behaves like a simple language client. For simplicity's sake, let's assume we're all Python developers and that we'd like to use a language server named <a href="https://github.com/pappasam/jedi-language-server">jedi-language-server</a> with Vim.</p>
<p>Within your current Python environment, install jedi-language-server:</p>
<div class="highlight"><pre><span></span>pip install jedi-language-server
</pre></div>


<p>Now run jedi-language-server:</p>
<div class="highlight"><pre><span></span>jedi-language-server
</pre></div>


<p>Notice that the process just hangs; it's waiting to receive standard input and will respond with standard output. This server can be configured to run inside of Vim by placing the following code in the <code>languageserver</code> section of your coc-settings.json:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;languageserver&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;python&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;jedi-language-server&quot;</span><span class="p">,</span>
      <span class="nt">&quot;filetypes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>If you're properly configured coc.nvim to work with your environment and you've installed jedi-language-server in the same Python environment that Vim has access to, Vim and jedi-language-server should communicate in a way that gives you autocomletion, goto definition, etc. Hooray!</p>
<h3>Problems with manual configuration</h3>
<p>It turns out there are some practical problems with expecting users to configure jedi-language-server manually:</p>
<ol>
<li>Remembering to manually install a language server can annoy people; shouldn't the editor remember to do that?</li>
<li>We'd like to configure the language server; can't that configuration have pretty autocompletion and look like the configuration I can use with all the other VSCode-like configuration options?</li>
<li>Expecting users to configure the server correctly means they'll naturally blame me if something breaks. There's a lot less back-and-forth if I provide correct default configurations for users that can be overridden instead of relying on the user to write correct configuration from scratch.</li>
</ol>
<p>This is where coc extensions come into play: they avoid the above problems with default configuration so users can get up and running with a language server with minimal friction!</p>
<h2>Writing a simple coc extension</h2>
<p>To keep things simple, let's restrict ourselves to 2 requirements:</p>
<ol>
<li>Prevent the user from needing to write manual configuration for jedi-language-server in coc-settings.json</li>
<li>Allow the user to configure the server as "disabled" if needed</li>
</ol>
<p>Additional features are left as exercises for the reader.</p>
<h3>Project skaffolding</h3>
<p>In <code>~/src</code>, use <a href="https://github.com/fannheyward/create-coc-extension">create-coc-extension</a> to create a project skeleton:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> yarn create coc-extension coc-jls
<span class="go">...</span>
<span class="go">? Project title: coc-jls</span>
<span class="go">? Project description: A great project</span>
<span class="go">? Author full name: Your name</span>
<span class="go">? Author email address: your.name@domain.com</span>
<span class="go">? Initialize a git repository? Yes</span>
<span class="go">? Install node dependencies? Yes</span>
<span class="go">  installing node dependencies...</span>
<span class="go">Done...</span>
<span class="gp">$</span> <span class="nb">cd</span> coc-jls
<span class="gp">$</span> yarn
</pre></div>


<p>You should have the following version-controlled files in coc-jls:</p>
<div class="highlight"><pre><span></span>LICENSE
README.md
package.json
src/
  index.ts
  lists.ts
tsconfig.json
webpack.config.js
yarn.lock
</pre></div>


<p>Delete the files in <code>src</code>; we'll be writing these from scratch.</p>
<h3>First file</h3>
<p>To get a simple wrapper around an existing jedi-language-server executable, place the following code in <code>src/index.ts</code>:</p>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">ExtensionContext</span><span class="p">,</span> <span class="nx">services</span><span class="p">,</span> <span class="nx">workspace</span><span class="p">,</span> <span class="nx">LanguageClient</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;coc.nvim&#39;</span>

<span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">activate</span><span class="p">(</span><span class="nx">context</span>: <span class="kt">ExtensionContext</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">serverOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">command</span><span class="o">:</span> <span class="s1">&#39;jedi-language-server&#39;</span><span class="p">,</span> <span class="c1">// run jedi-language-server</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">clientOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">documentSelector</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">],</span> <span class="c1">// only use jedi-language-server on Python files</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LanguageClient</span><span class="p">(</span>
    <span class="s1">&#39;coc-jls&#39;</span><span class="p">,</span> <span class="c1">// the id</span>
    <span class="s1">&#39;coc-jls&#39;</span><span class="p">,</span> <span class="c1">// the name of the language server</span>
    <span class="nx">serverOptions</span><span class="p">,</span>
    <span class="nx">clientOptions</span>
  <span class="p">)</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">services</span><span class="p">.</span><span class="nx">registLanguageClient</span><span class="p">(</span><span class="nx">client</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>


<p>This code tells coc to register a new language server named <code>coc-jls</code> that executes the command <code>jedi-language-server</code> when Vim edits Python file(s). Now build the project with the following command:</p>
<div class="highlight"><pre><span></span>yarn
</pre></div>


<p>Open an empty file (test.py works) with Vim and run the following command:</p>
<div class="highlight"><pre><span></span><span class="p">:</span><span class="k">set</span> <span class="nb">runtimepath</span>^<span class="p">=~</span><span class="sr">/src/</span><span class="k">sandbox</span>/coc<span class="p">-</span>jls
</pre></div>


<p>This command will help coc discover your extension. Depending on your coc configuration, you should see diagnostics, have autocompletion, etc. In the long term, you may want to manage your coc extension as a plugin or a Vim <a href="https://shapeshed.com/vim-packages">package</a>, but we'll keep things local and simple for now.</p>
<h3>User configuration</h3>
<p>We've successfully wrapped jedi-language-server with a coc extension and now it's time to add some user configuration! Luckily, coc provides a simple mechanism to help users communicate their configuration values in the same way as VSCode: through the package.json. Make sure the following lines are in your package.json:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;contributes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;configuration&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;coc-jls configuration&quot;</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;coc-jls.enabled&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
          <span class="nt">&quot;default&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Enable coc-jls extension&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This says that the coc-jls extension contributes a configuration key <code>coc-jls.enabled</code> whose default value is <code>true</code>. If a user wants to disable <code>coc-jls</code>, they'll need to add the following line to the top level of their coc-settings.json:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;coc-jls.enabled&quot;</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</pre></div>


<p>Now we must add some logic to our typescript code to read the user configuration and disable the server if the user has chosen not to have it enabled:</p>
<div class="highlight"><pre><span></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">ExtensionContext</span><span class="p">,</span> <span class="nx">services</span><span class="p">,</span> <span class="nx">workspace</span><span class="p">,</span> <span class="nx">LanguageClient</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;coc.nvim&#39;</span>

<span class="kr">export</span> <span class="nx">async</span> <span class="kd">function</span> <span class="nx">activate</span><span class="p">(</span><span class="nx">context</span>: <span class="kt">ExtensionContext</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// BEGIN NEW CODE</span>
  <span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">workspace</span><span class="p">.</span><span class="nx">getConfiguration</span><span class="p">(</span><span class="s1">&#39;coc-jls&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">isEnable</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="o">&lt;</span><span class="kr">boolean</span><span class="o">&gt;</span><span class="p">(</span><span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEnable</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>
  <span class="p">}</span>
  <span class="c1">// END NEW CODE</span>
  <span class="kr">const</span> <span class="nx">serverOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">command</span><span class="o">:</span> <span class="s1">&#39;jedi-language-server&#39;</span><span class="p">,</span> <span class="c1">// run jedi-language-server</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">clientOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">documentSelector</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">],</span> <span class="c1">// only use jedi-language-server on Python files</span>
  <span class="p">}</span>
  <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LanguageClient</span><span class="p">(</span>
    <span class="s1">&#39;coc-jls&#39;</span><span class="p">,</span> <span class="c1">// the id</span>
    <span class="s1">&#39;coc-jls&#39;</span><span class="p">,</span> <span class="c1">// the name of the language server</span>
    <span class="nx">serverOptions</span><span class="p">,</span>
    <span class="nx">clientOptions</span>
  <span class="p">)</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">subscriptions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">services</span><span class="p">.</span><span class="nx">registLanguageClient</span><span class="p">(</span><span class="nx">client</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>


<p>Now run <code>yarn</code> and voil√†: users can now disable coc-jls without needing to uninstall the extension. Success!</p>
<h3>Deployment</h3>
<p>To "deploy" this extension, one approach is to upload your project GitHub, add it to your Package or Plugin manager configuration, and install. If you're using <a href="https://github.com/junegunn/vim-plug">Vim-Plug</a>, put the following in your vimrc:</p>
<div class="highlight"><pre><span></span>Plug <span class="s1">&#39;your-username/coc-jls&#39;</span><span class="p">,</span> {<span class="s1">&#39;do&#39;</span>: <span class="s1">&#39;yarn install --frozen-lockfile &amp;&amp; yarn build&#39;</span>}
</pre></div>


<p>And run:</p>
<div class="highlight"><pre><span></span><span class="p">:</span>PlugInstall
</pre></div>


<p>This will download your Git repository, install all necessary dependencies, build your project, and make sure it's automatically added to Vim's runtime path for coc can discover the extension.</p>
<p>Alternatively, you can do all this manually if you know what you're doing.</p>
<p>Finally, coc extensions can be deployed to <a href="https://www.npmjs.com">npm</a>. This method is out of scope for this post, but you should be able to figure it out by referencing the <a href="https://github.com/pappasam/coc-jedi">coc-jedi</a> codebase.</p>
<h2>Wrapping up</h2>
<p>At this point, you should have a working coc extension that wraps an executable language server. You may be wondering how you can add more features, automatically download and manage the executable for your users, and make your coc extension the most user friendly interface since the <a href="https://en.wikipedia.org/wiki/IPod_click_wheel">iPod click wheel</a>. The good news is that many of these features have already been implemented in <a href="https://github.com/pappasam/coc-jedi">coc-jedi</a>; please refer to that codebase and ask any further questions you may have in the comments below. And don't feel obligated to only wrap jedi-language-server: you should now be able to wrap <strong>any</strong> executable language server in a coc extension! Please use your powers for good.</p>
<p><img alt="jedi programmer" src="https://www.kumulos.com/wp-content/uploads/2012/09/Computer-programming-jedi.jpg"></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://samroeca.com/tag/vim.html">Vim</a>
      <a href="https://samroeca.com/tag/vim-plugins.html">Vim Plugins</a>
      <a href="https://samroeca.com/tag/lsp.html">LSP</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="https://samroeca.com/ignore-git.html" title="Gitignore-A-Palooza: Two Tricks">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'pappasam-github-io';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  </p>
<p>Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Software Journeyman ",
  "url" : "https://samroeca.com",
  "image": "/images/sam-headshot-kepler-300x300.jpg",
  "description": "Samuel Roeca's blog"
}
</script>

</body>
</html>